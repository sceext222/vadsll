<!-- vadsll/doc/dev/
-->

# VADSL 协议


为了更好地说明 VADSL 的工作方式, 下面举个例子.

```
$ cat server_res.OK.json
{
    "#": "vadsll login log",
    "interface": "enp0s8",
    "mac": "01:00:00:cc:dd:ff",
    "ip": "172.7.1.222",
    "auth_server": "172.7.10.5:1812",
    "account": "12344446666",
    "server_res": {
        "type": "OK",
        "gateway": "172.7.20.3",
        "route_filter": [
            "0.0.0.0/255.255.255.255",
            "10.0.0.0/255.0.0.0",
            "172.7.0.0/255.255.0.0",
            "192.168.0.0/255.255.0.0",
            "255.255.255.255/255.255.255.255"
        ]
    },
    "time": "2017-05-17T11:58:45.102Z"
}
$
```

上面是一个登陆成功后 VADSLL 生成的日志文件 (已修改), 有这些重要信息:

+ **网络接口**: `enp0s8` <br />
  使用哪一个 *网卡* 连接到外网.

+ **MAC 地址**: `01:00:00:cc:dd:ff` <br />
  网络接口的 MAC.

+ **本机 IP**: `172.7.1.222` <br />
  默认网关 (假设为) `172.7.1.1`

+ **认证服务器**: `172.7.10.5`, TCP 端口 `1812` <br />
  登陆时需要向认证服务器发送 帐号/密码 等.

+ **帐号**: `12344446666` <br />
  登陆的帐号.

+ **转接网关**: `172.7.20.3` <br />
  发送到外网 (Internet) 的数据包, 需要发送给 转接网关.

+ **路由过滤信息**: (共 5 条, 此处 略) <br />
  路由过滤 指定发送到哪些网络的数据包, **不需要** 通过 转接网关 发送
  (也就是 直接发送).


## 观察方法

使用 `wireshark` (TODO) 捕获网卡的数据包,
同时使用 *官方的 VADSL 客户端* 登陆/下线, 发送数据等,
便可清晰地观察到 VADSL 的工作过程.


## 登陆/下线/保活

登陆 (login) / 下线 (logout) / 保活 (keep-alive)
这 3 种 操作, 通过 客户端 向 认证服务器 发送数据来实现.

客户端 和 认证服务器 之间使用 TCP 通信 (通常连接服务器的 1812 端口),
使用 明文方式 发送 大约几十个字节 的 二进制格式 数据包.

关于 二进制数据包 的 具体格式 (及其 构造/解析 等), 详见 源代码 的 (TODO) 部分.

+ **登陆**

  客户端 连接至 认证服务器 的 TCP 端口, 发送 **登陆数据包**,
  包含 帐号/密码/本机IP/MAC地址 (TODO) 等 信息.

  服务器 返回 **响应数据包**.
  如果 登陆成功, 则响应包含 转接网关/路由过滤 等 信息.
  如果 登陆失败, 服务器 通常 返回 错误原因 (一个 字符串).

  **注意**: 密码 是 **明文** 发送的 (没有 加密! )

  服务器返回 登陆成功 之后, 客户端 需要 再发送一个 **确认数据包** 来完成 登陆过程.

+ **下线**

  客户端 连接至 认证服务器 的 TCP 端口, 发送 **下线数据包**,
  包含 帐号/本机IP/MAC地址 (TODO) 等 信息.

  然后 客户端 **等待 服务器 关闭** TCP 连接.

  **注意**:
  + **1**. 服务器 不会返回响应数据
  + **2**. 如果 客户端 没有等待 服务器 关闭连接 (而是 客户端 主动关闭 TCP 连接),
       可能导致 下线 失败!

+ **保活**

  客户端 定期 向 认证服务器 发送 **保活数据包**.
  如果 认证服务器 长时间 没有收到 保活数据包, 就会认为 客户端 已经 掉线!

  大约每隔 300秒 (5分钟) 发送一次 保活数据包 (不同服务器 可能有不同设置).

  **注意**: 服务器 不会返回响应数据.


## 路由过滤/数据包处理

发送到 外网 (Internet) 的 数据包 (IP 数据包) 不能 直接发送 (即 发送给 默认网关),
而需要 经过处理后 发送给 **转接网关**, 再由 转接网关 发送到 外网.

对于 每个 需要 发送给 外网 的 IP 数据包, VADSL 客户端 需要 在 原始 IP 数据包
前面加上 一个 GRE 的 (固定) 头部, 再 在其前面加上 一个 IP 头部.
最后将 封装处理 后的 数据包, 发送给 转接网关.

从 外网 发送回来的 IP 数据包 是 普通的 IP 数据包, 不需要 进行处理.

对于 IP 数据包 的 具体处理 过程, 详见 `route_filter` (TODO) 程序的 源代码.


VADSLL 使用 `nftables` 实现 路由过滤/数据包处理 等 功能.
